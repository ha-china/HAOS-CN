name: Mirror Home Assistant Images to GHCR

on:
  schedule:
    - cron: "0 3 * * *"   # 每天凌晨3点自动同步
  workflow_dispatch: {}    # 可以手动触发

permissions:
  contents: read
  packages: write  # GITHUB_TOKEN 推送 GHCR

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq skopeo curl

      - name: Fetch stable.json
        run: |
          curl -sSL https://version.home-assistant.io/stable.json -o stable.json

      - name: Mirror images to GHCR
        env:
          DEST_NAMESPACE: "ghcr.io/ha-china"
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          DEST_NAMESPACE="ghcr.io/ha-china"
          ARCH_LIST=("armhf" "armv7" "aarch64" "amd64" "i386")

          # -----------------------------
          # 1. Core 镜像
          # -----------------------------
          jq -r '.homeassistant | to_entries[] | "\(.key) \(.value)"' stable.json | while read -r machine version; do
            src_image="ghcr.io/home-assistant/${machine}-homeassistant:${version}"
            dest="docker://${DEST_NAMESPACE}/${machine}-homeassistant:${version}"

            echo ">>> Processing core: $src_image"

            src_digest=$(skopeo inspect "docker://${src_image}" | jq -r '.Digest')
            dest_digest=$(skopeo inspect --creds "${GITHUB_ACTOR}:${GITHUB_TOKEN}" "$dest" 2>/dev/null | jq -r '.Digest' || true)

            if [ "$src_digest" != "$dest_digest" ]; then
                echo ">>> Mirror update: $src_image -> $dest"
                skopeo copy --all --dest-creds "${GITHUB_ACTOR}:${GITHUB_TOKEN}" "docker://${src_image}" "$dest"
            else
                echo ">>> No update needed for $src_image"
            fi
            done

# 有人喜欢偷别人的劳动成果恶心抹除出处占为己有~继续偷~你猜我这个工作流是干嘛用的

