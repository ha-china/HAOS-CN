name: Mirror Home Assistant Images to GHCR

on:
  schedule:
    - cron: "0 3 * * *"   # 每天凌晨3点自动同步
  workflow_dispatch: {}    # 可以手动触发

permissions:
  contents: read
  packages: write  # 确保 GITHUB_TOKEN 可以推送 GHCR

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq skopeo curl

      - name: Fetch stable.json
        run: |
          curl -sSL https://version.home-assistant.io/stable.json -o stable.json

      - name: Mirror images to GHCR
        env:
          DEST_NAMESPACE: "ghcr.io/ha-hcina"
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # 遍历 stable.json 的架构字段
          jq -r 'to_entries[] | select(.key != "supervisor") | .key as $arch | .value | to_entries[] | .key as $image_name | .value as $version | "\($arch) \($image_name) \($version)"' stable.json | \
          while read -r arch image_name version; do

              # core 镜像需要遍历 machine
              if [[ "$image_name" == "core" ]]; then
                  jq -r '.homeassistant | to_entries[] | "\(.key) \(.value)"' stable.json | while read -r machine core_version; do
                      src_image="ghcr.io/home-assistant/${machine}-homeassistant:${core_version}"
                      echo ">>> Processing core: $src_image"

                      dest="docker://${DEST_NAMESPACE}/${machine}-homeassistant:${core_version}"

                      # 获取源 digest
                      src_digest=$(skopeo inspect "docker://${src_image}" | jq -r '.Digest')

                      # 获取目标 digest
                      dest_digest=$(skopeo inspect --creds "${GITHUB_ACTOR}:${GITHUB_TOKEN}" "$dest" 2>/dev/null | jq -r '.Digest' || true)

                      if [ "$src_digest" != "$dest_digest" ]; then
                          echo ">>> Mirror update: $src_image -> $dest"
                          skopeo copy --all --dest-creds "${GITHUB_ACTOR}:${GITHUB_TOKEN}" "docker://${src_image}" "$dest"

                          # 验证目标镜像
                          skopeo inspect --creds "${GITHUB_ACTOR}:${GITHUB_TOKEN}" "$dest"
                      else
                          echo ">>> No update needed for $src_image"
                      fi
                  done
              else
                  # 非 core 镜像直接替换 arch
                  src_image="ghcr.io/home-assistant/${arch}-${image_name}:${version}"
                  echo ">>> Processing $src_image"

                  dest="docker://${DEST_NAMESPACE}/${arch}-${image_name}:${version}"

                  # 获取源 digest
                  src_digest=$(skopeo inspect "docker://${src_image}" | jq -r '.Digest')

                  # 获取目标 digest
                  dest_digest=$(skopeo inspect --creds "${GITHUB_ACTOR}:${GITHUB_TOKEN}" "$dest" 2>/dev/null | jq -r '.Digest' || true)

                  if [ "$src_digest" != "$dest_digest" ]; then
                      echo ">>> Mirror update: $src_image -> $dest"
                      skopeo copy --all --dest-creds "${GITHUB_ACTOR}:${GITHUB_TOKEN}" "docker://${src_image}" "$dest"

                      # 验证目标镜像
                      skopeo inspect --creds "${GITHUB_ACTOR}:${GITHUB_TOKEN}" "$dest"
                  else
                      echo ">>> No update needed for $src_image"
                  fi
              fi
          done

# 有人喜欢偷别人的劳动成果恶心抹除出处占为己有~继续偷~你猜我这个工作流是干嘛用的

