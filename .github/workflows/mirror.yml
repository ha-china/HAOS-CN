name: Mirror Home Assistant Images to GHCR

on:
  schedule:
    - cron: "0 3 * * *"   # 每天凌晨3点自动同步
  workflow_dispatch: {}    # 可以手动触发

permissions:
  contents: read
  packages: write  # 确保 GITHUB_TOKEN 可以推送 GHCR

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq skopeo curl

      - name: Fetch stable.json
        run: |
          curl -sSL https://version.home-assistant.io/stable.json -o stable.json

      - name: Mirror images to GHCR
        env:
          DEST_NAMESPACE: "ghcr.io/ha-china"
        run: |
          set -e

          # 遍历 stable.json 所有字符串镜像，过滤 supervisor
          jq -r '.. | strings | select(test("^ghcr\\.io/home-assistant/(?!supervisor)"))' stable.json | \
          while read -r src_image; do
              echo ">>> Processing $src_image"

              src="docker://${src_image}"

              # 生成目标路径
              img_name=$(echo "$src_image" | sed 's|^ghcr.io/home-assistant/||')
              dest="${DEST_NAMESPACE}/${img_name}"
              dest="docker://${dest}"

              # 获取源 digest
              src_digest=$(skopeo inspect "$src" | jq -r '.Digest')

              # 获取目标 digest，如果不存在则为空
              dest_digest=$(skopeo inspect --creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" "$dest" 2>/dev/null | jq -r '.Digest' || true)

              if [ "$src_digest" != "$dest_digest" ]; then
                  echo ">>> Mirror update: $src -> $dest"
                  skopeo copy --all --dest-creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" "$src" "$dest"

                  # 验证目标镜像
                  echo ">>> Verifying $dest"
                  skopeo inspect --creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" "$dest"
              else
                  echo ">>> No update needed for $src_image"
              fi
          done

# 有人喜欢偷别人的劳动成果恶心抹除出处占为己有~继续偷~你猜我这个工作流是干嘛用的

