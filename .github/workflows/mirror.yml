name: Mirror Home Assistant images

on:
  schedule:
    - cron: "0 3 * * *"   
  workflow_dispatch: {}

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq skopeo curl

      - name: Fetch HA stable.json
        run: |
          curl -sSL https://version.home-assistant.io/stable.json -o stable.json

      - name: Mirror images (skip supervisor) and verify
        env:
          DEST_NAMESPACE: "ghcr.io/${{ github.repository_owner }}"
        run: |
          set -e
          for image in $(jq -r '..|objects|select(has("image"))|.image' stable.json); do
            if [[ "$image" == *"supervisor"* ]]; then
              echo ">>> Skipping supervisor: $image"
              continue
            fi

            echo ">>> Processing $image"
            src="docker://${image}"

            # 改写目标仓库路径
            img_name=$(echo $image | sed 's|^ghcr.io/home-assistant/||')
            dest="${DEST_NAMESPACE}/${img_name}"
            dest="docker://${dest}"

            # 获取源镜像 digest
            src_digest=$(skopeo inspect $src | jq -r '.Digest')

            # 获取目标 digest（不存在时为空）
            dest_digest=$(skopeo inspect --creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" \
                          $dest 2>/dev/null | jq -r '.Digest' || true)

            if [ "$src_digest" != "$dest_digest" ]; then
              echo ">>> Mirror update: $src -> $dest"
              skopeo copy --all --dest-creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" $src $dest
              
              # 验证目标是否存在
              echo ">>> Verifying $dest"
              skopeo inspect --creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" $dest
            else
              echo ">>> No update needed for $image"
            fi
          done
# 有人喜欢偷别人的劳动成果恶心抹除出处占为己有~继续偷~你猜我这个工作流是干嘛用的

